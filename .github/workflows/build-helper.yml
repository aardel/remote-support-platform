# Build Windows EXE and macOS DMG, then upload to server.
# Trigger: push to main, or "Run workflow" in Actions.
# Deploy: runs automatically after every successful build when DEPLOY_SSH_KEY (and SERVER_*) secrets are set.

name: Build Helper (Win + Mac)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version label (optional)"
        required: false
        default: ""

env:
  NODE_VERSION: "22"

jobs:
  build-win:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install Python setuptools (provides distutils for Python 3.12+)
        run: python -m pip install setuptools
      - name: Sync version from root (helper + frontend)
        run: node scripts/sync-version.js ${{ github.event.inputs.version }}
      - name: Install helper dependencies
        working-directory: helper
        run: npm install
      - name: Rebuild native modules for Electron
        working-directory: helper
        run: npm run postinstall || echo "postinstall completed (may have warnings)"
      - name: Build EXE
        working-directory: helper
        run: npm run build:win
      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: helper-exe
          path: helper/dist/*.exe

  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install Python setuptools (provides distutils for Python 3.12+)
        run: python3 -m pip install --break-system-packages setuptools
      - name: Sync version from root (helper + frontend)
        run: node scripts/sync-version.js ${{ github.event.inputs.version }}
      - name: Install helper dependencies
        working-directory: helper
        run: npm install
      - name: Build DMG
        working-directory: helper
        run: npm run build:mac
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: helper-dmg
          path: helper/dist/*.dmg

  # Upload latest EXE and DMG to server. Set repo variable DEPLOY_ENABLED = true (Actions â†’ Variables) when deploy secrets are set.
  # Secrets: DEPLOY_SSH_KEY, SERVER_HOST, SERVER_USER; optional SERVER_PACKAGES_PATH (e.g. /opt/remote-support/packages).
  deploy-templates:
    runs-on: ubuntu-latest
    needs: [build-win, build-mac]
    if: ${{ vars.DEPLOY_ENABLED == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Get helper version
        id: get_version
        run: echo "version=$(node -p "require('./helper/package.json').version")" >> $GITHUB_OUTPUT
      - name: Download EXE
        uses: actions/download-artifact@v4
        with:
          name: helper-exe
          path: exe
      - name: Download DMG
        uses: actions/download-artifact@v4
        with:
          name: helper-dmg
          path: dmg
      - name: Deploy to server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PACKAGES_PATH: ${{ secrets.SERVER_PACKAGES_PATH }}
          SERVER_SSH_PORT: ${{ secrets.SERVER_SSH_PORT }}
        run: |
          DEPLOY_PATH="${SERVER_PACKAGES_PATH:-packages}"
          SSH_PORT="${SERVER_SSH_PORT:-22}"
          mkdir -p ~/.ssh
          # Support raw PEM or base64-encoded key (avoids "error in libcrypto" when newlines are lost pasting into GitHub)
          if echo "$SSH_PRIVATE_KEY" | grep -q -e "-----BEGIN"; then
            printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          else
            echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/deploy_key
          fi
          chmod 600 ~/.ssh/deploy_key
          SSH_OPTS="-o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -i ~/.ssh/deploy_key -p $SSH_PORT"
          SCP_OPTS="-o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -i ~/.ssh/deploy_key -P $SSH_PORT"
          ssh $SSH_OPTS ${SERVER_USER}@${SERVER_HOST} "mkdir -p $DEPLOY_PATH"
          exe=$(ls exe/*.exe 2>/dev/null | head -1)
          dmg=$(ls dmg/*.dmg 2>/dev/null | head -1)
          [ -n "$exe" ] && scp $SCP_OPTS "$exe" ${SERVER_USER}@${SERVER_HOST}:${DEPLOY_PATH}/support-template.exe
          [ -n "$dmg" ] && scp $SCP_OPTS "$dmg" ${SERVER_USER}@${SERVER_HOST}:${DEPLOY_PATH}/support-template.dmg
          ssh $SSH_OPTS ${SERVER_USER}@${SERVER_HOST} "echo '${{ steps.get_version.outputs.version }}' > ${DEPLOY_PATH}/support-template.version"
          rm -f ~/.ssh/deploy_key
